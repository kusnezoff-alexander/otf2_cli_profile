# inspired by https://www.vortech.nl/en/integrating-sphinx-in-cmake/

find_package(OTF2) # to find OTF2 includes
find_package(Sphinx)
# If finding Sphinx fails, there is no use in defining
# add_sphinx_document, so return early
if(NOT Sphinx_FOUND)
	message(WARNING "Sphinx not found...")
    return()
endif()

message(STATUS "sphinx-build found: ${SPHINX_BUILD}")
message(STATUS "Doxygen found: ${DOXYGEN_EXECUTABLE}")

# Paths
set(SRC_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../src)
set(INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../include)
set(DOC_SRC_DIR ${CMAKE_CURRENT_SOURCE_DIR})
set(DOC_BUILD_DIR ${CMAKE_CURRENT_BINARY_DIR})
set(DOXYGEN_XML_DIR ${DOC_BUILD_DIR}/doxygen/xml)

# Ensure output dir exists
file(MAKE_DIRECTORY ${DOC_BUILD_DIR}/doxygen)

# Configure Doxygen
set(DOXYFILE_IN  ${CMAKE_CURRENT_BINARY_DIR}/Doxyfile)
file(WRITE ${DOXYFILE_IN}
	"INPUT = ${INCLUDE_DIR}
OUTPUT_DIRECTORY = ${DOC_BUILD_DIR}/doxygen
GENERATE_XML = YES
RECURSIVE = YES
EXTRACT_ALL = YES
QUIET = YES
# see [Github Issue](https://github.com/doxygen/doxygen/issues/9049#issuecomment-1016280535) (TODO: didn't solve the issue)
SEARCH_INCLUDES = YES
INCLUDE_PATH = ${INCLUDE_DIR}
")

message("OTF2 Prefix: ${OTF2_PREFIX}/include")

# ===== Write Project Info to `conf.py`:
set(CONF_SPHINX "${DOC_SRC_DIR}/conf.py")
file(WRITE ${CONF_SPHINX} "
# DON'T EDIT this file - it is automatically generated by cmake
import os
import sys
# see [StackOverflow](https://stackoverflow.com/a/62613202) on how to automatically show all classes in Docs
sys.path.insert(0, os.path.abspath('..'))  # Source code dir relative to this file

project = '${CMAKE_PROJECT_NAME}'
author = '${CMAKE_PROJECT_NAME}_AUTHOR'
release = '${CMAKE_PROJECT_VERSION}'
extensions = [
	'myst_parser',
	'breathe',
    'sphinx.ext.autodoc',  # Core library for html generation from docstrings
    'sphinx.ext.autosummary',  # Create neat summary tables
]
autosummary_generate = True  # Turn on sphinx.ext.autosummary

# Optional: treat .md files as documents
source_suffix = {
	'.rst': 'restructuredtext',
	'.md': 'markdown',
}

# pull in XML from Doxygen
breathe_projects = {
    '${CMAKE_PROJECT_NAME}' : '${DOXYGEN_XML_DIR}'
}
breathe_default_project = '${CMAKE_PROJECT_NAME}'
")

# Target: Doxygen
add_custom_target(doxygen
    COMMAND ${DOXYGEN_EXECUTABLE} ${DOXYFILE_IN}
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
    COMMENT "Generating XML documentation with Doxygen"
    VERBATIM
)

# auto-generate docs from Docstrings
set(API_OUTPUT_DIR ${DOC_BUILD_DIR}/_autosummary)
file(MAKE_DIRECTORY ${API_OUTPUT_DIR})

add_custom_target(sphinx-apidoc
    COMMAND ${Python3_EXECUTABLE} -m sphinx.ext.apidoc
        -o ${API_OUTPUT_DIR}
        ${SRC_DIR}
        --force --no-toc
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
    COMMENT "Generating reStructuredText files from Python docstrings with sphinx-apidoc"
    VERBATIM
)

# Target: Build Sphinx docs using sphinx-build
add_custom_target(docs
    COMMAND ${CMAKE_COMMAND} -E make_directory ${DOC_BUILD_DIR}
	COMMAND ${SPHINX_BUILD} -b html ${DOC_SRC_DIR} ${DOC_BUILD_DIR}/html
    DEPENDS doxygen sphinx-apidoc
    COMMENT "Building HTML documentation with Sphinx"
    VERBATIM
)

# Optional: clean target
add_custom_target(clean-docs
    COMMAND ${CMAKE_COMMAND} -E rm -rf ${DOC_BUILD_DIR}
    COMMENT "Cleaning generated documentation"
)
